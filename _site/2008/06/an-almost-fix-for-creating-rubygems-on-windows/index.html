<!DOCTYPE html> 
<html lang="en"> 
    <head> 
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>An Almost Fix for Creating RubyGems on Windows</title> 
				<meta name="author" content="Ben Emson" />
				<link href="http://feeds.feedburner.com/ben-emson" rel="alternate" title="Ben Emsonr" type="application/atom+xml" />

			   <!-- syntax highlighting CSS -->
			   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

			   <!-- Homepage CSS -->
			   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
    </head> 
 
    <body>  
        <div id="container"> 
 
            <h1><a href="http://blog.emson.co.uk">Ben Emson</a></h1> 
            
            <div id="post">
<h1>An Almost Fix for Creating RubyGems on Windows</h1>

<h2>Introduction</h2>

<p>I wrote this article originally so that I could write command-line apps using Ruby, as I got further and further down the line I realised that what I really wanted to do was create a command-line app using RubyGems.  I use both Windows and an Apple Mac and I quickly found myself having problems trying to create RubyGems on Windows.</p>

<p>In this article I try to explain my thought process and the problems I encountered.  Unfortunately I had to employ a manual process when trying to package up my project into a <em>tar</em> file, as there isn't a simple way to do this in Windows (let me know if you have a solution), however everything else seems to work.</p>

<h2>What's a RubyGem?</h2>

<p>One of the joys of Ruby is the <a href="http://www.rubygems.org/">RubyGems</a> packaging system.
It is essentially a tool written in Ruby, for packaging up source code for deployment.</p>

<p>The RubyGems site describes it as follows:</p>

<blockquote><p>RubyGems is the premier ruby packaging system. It provides:</p>

<ul>
<li>A standard format for destributing Ruby programs and libraries.</li>
<li>An easy to use tool for managing the installation of gem packages.</li>
<li>A gem server utility for serving gems from any machine where RubyGems is installed.</li>
</ul>
</blockquote>

<h2>Why should I create a RubyGem?</h2>

<p>Maybe a better question should be <em>when</em> should I package my code up into a RubyGem.  Obviously there are no hard and fast rules but if you are going to share your code libraries with others or even with other applications of yours, you should think about using a gem.</p>

<p>Now you might think that you don't want to make all your code public on <a href="http://rubyforge.org/">RubyForge</a>, and there are very good reason not to publish every gem, so you don't have to.
RubyGems comes with its own <em>local</em> gem server so you can create your own gem library and share it amoung your other Ruby applications.</p>

<p>This is really quite useful, you get the power of RubyGems without the commitment and maintenance work of making your code OpenSource.  Plus at any point in time you can then make it OpenSource, and live off the joy of the Ruby community :).</p>

<p>The reason I wrote this article is because I wanted to create a simple command-line application using Ruby. I went through a number of steps before realising that the best way was to use RubyGems.</p>

<p>I started by creating my own command-line structure and then found this great article by <a href="http://blog.infinitered.com/entries/show/5">Todd Werth</a>.  He has a single Ruby file that you just replace various sections and viola you have a very simple command-line app.  But it wasn't quite what I wanted.  I didn't want to have to type:</p>

<pre><code>./my_super_app 'some params'
</code></pre>

<p>I wanted to type:</p>

<pre><code>my_super_app 'some params'
</code></pre>

<p>I also wanted the structure of the application to follow a standard structure and I didn't want to put '.' into my path, for security reasons.
<a href="http://drnicwilliams.com/">Dr Nic</a> came to the rescue with a couple of excellent articles describing how to <a href="http://drnicwilliams.com/2006/10/11/generating-new-gems/">create gems using <strong>newgem</strong></a> and specifically <a href="http://drnicwilliams.com/2006/10/18/create-and-deploy-command-line-apps-with-rubygems/">command-line apps as gems</a>.</p>

<h2>Installing newgem on Windows</h2>

<p>To install <strong>newgem</strong> on Windows use the RubyGems install method.</p>

<pre><code>gem install newgem
</code></pre>

<p>This will install the gem and its dependencies.  However one of its dependencies is the <a href="http://seattlerb.rubyforge.org/hoe/">Hoe gem</a>, and there is a slight issue using it on Windows.</p>

<h3>What is hoe?</h3>

<p>Hoe is a compliment to <strong>rake</strong>, it was created by <a href="http://zenspider.com/">Ryan Davis</a> and provides <strong>rake</strong> tasks for testing, packaging, and releasing RubyGems.  <a href="http://nubyonrails.com/articles/tutorial-publishing-rubygems-with-hoe">Geoffrey Grosenbach has a nice tutorial for using hoe</a> and also describes how to create a project structure using the <strong>sow</strong> task.</p>

<p>Hoe uses a <strong>.hoerc</strong> file for configuration, and this file should reside in the user's home directory, something like:</p>

<pre><code>C:\Documents and Settings\MyUserName
</code></pre>

<p>An example <strong>.hoerc</strong> file should look like the one below.  Please note that this is a <a href="http://en.wikipedia.org/wiki/YAML">YAML</a> file and if you copy it from here remember to follow the indentation convention:</p>

<pre><code>---
publish_on_announce: false
exclude: !ruby/regexp/tmp$|CVS|\.svn|_darcs|\.git|log$|local/.*\.rb$|Makefile|.*\.o$|.*\.bundle$|.*\.so$|.*\.dll$/ 
str: ""
"@taguri": tag:ruby.yaml.org,2002:regexp/tmp$|CVS|\.svn|_darcs|\.git|log$|local/.*\.rb$|Makefile|.*\.o$|.*\.bundle$|.*\.so$|.*\.dll$/
blogs:
- user: user
  url: url
  extra_headers:
    mt_convert_breaks: markdown
  blog_id: blog_id
  password: password
</code></pre>

<p>On Unix systems there is a shortcut to the user's home directory which is '~' and on Windows this isn't a shortcut.  Windows however does have an environment variable <strong>HOMEPATH</strong> which will point to the user's home directory.  The problem is that the Hoe gem code uses '~' in its <strong>hoe.rb</strong> file and this causes problems for Windows users.</p>

<h3>Patching the hoe.rb file</h3>

<p>OK, be brave, lets tweak the hoe.rb file so that it will work on the Windows platform.
The Hoe gem <strong>hoe.rb</strong> file can be found in the following directory (assuming you installed Ruby to the standard location):</p>

<pre><code>C:\ruby\lib\ruby\gems\1.8\gems\hoe-1.6.0\lib
</code></pre>

<p>To make it work for Windows PCs you will need to modify this file with the following changes.</p>

<p>Locate the <strong>define_tasks</strong> method:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">define_tasks</span> <span class="c1"># :nodoc:</span>
  <span class="k">def</span> <span class="nf">with_config</span> <span class="c1"># :nodoc:</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;~/.hoerc&quot;</span><span class="p">)</span>
    <span class="n">exists</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="n">rc</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">exists</span> <span class="p">?</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">:</span> <span class="p">{}</span>
    <span class="k">yield</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre>
</div>


<p>And add a new method above it such as this, and modify the line <strong>rc = File.expand_path("~/.hoerc")</strong> as below:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">get_home_dir</span>
  <span class="n">home_file_path</span> <span class="o">=</span> <span class="s2">&quot;~/&quot;</span>
  <span class="n">home_file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOMEPATH&#39;</span><span class="o">]</span><span class="si">}</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="no">WINDOZE</span>
  <span class="n">home_file_path</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">define_tasks</span> <span class="c1"># :nodoc:</span>
 <span class="k">def</span> <span class="nf">with_config</span> <span class="c1"># :nodoc:</span>
   <span class="n">rc</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">get_home_dir</span> <span class="o">+</span> <span class="s1">&#39;.hoerc&#39;</span><span class="p">)</span>
   <span class="n">exists</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="n">rc</span>
   <span class="n">config</span> <span class="o">=</span> <span class="n">exists</span> <span class="p">?</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">:</span> <span class="p">{}</span>
   <span class="k">yield</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
 <span class="k">end</span>
</code></pre>
</div>


<p>Finally you will need to locate and change the <strong>task :config_hoe</strong> so that it reads:</p>

<pre><code>"signing_key_file" =&gt; "#{get_home_dir}.gem/gem-private_key.pem",
"signing_cert_file" =&gt; "#{get_home_dir}.gem/gem-public_cert.pem",
</code></pre>

<p>If all has gone correctly save this file and you are now ready to create a RubyGem.</p>

<h2>Creating a basic RubyGem</h2>

<p>Using the <strong>newgem</strong> RubyGem enter the following command at the command prompt:</p>

<pre><code>newgem my_app -b greetings -T rspec -W
</code></pre>

<p>This will create a <strong>my_app</strong> subdirectory, with a command-line command app called <em>greetings</em> located in the <strong>bin</strong> directory.  It will use the testing framework <em>RSpec</em> and finally will not generate the RubyForge web site code.  This is assuming you don't want to relese your code as OpenSource.
The output will be something like this:</p>

<pre><code>     create
     create  config
     create  doc
     create  lib
     create  script
     ... blah ...
     create  script/console
     create  script/console.cmd
     create  Manifest.txt
     readme  readme
Important
=========

* Open config/hoe.rb
* Update missing details (gem description, dependent gems, etc.)
</code></pre>

<p>If you want to add <a href="http://blog.emson.co.uk/2008/06/understanding-rspec-stories-a-tutorial/">RSpec Stories</a> to this project there is a useful command-line generator to do this.  First navigate into the root of you new project app directory, in this case <strong>my_app</strong>.  Now execute the generate script:</p>

<div class="highlight"><pre><code class="bash">ruby script/generate install_rspec_stories
</code></pre>
</div>


<p>You should then get the following output:</p>

<pre><code>  create  stories/steps
  create  stories/steps/my_app_steps.rb
  create  stories/sell_my_app.story
  create  stories/all.rb
</code></pre>

<p>Modify your <strong>greetings</strong> command so that it does something.  Do this by editing the file located here:</p>

<pre><code>my_app/bin/greetings
</code></pre>

<p>Open up this file and at the very end, add some code such as this, and save the file:</p>

<pre><code># do stuff
puts 'Greetings the world is my oyster!'
</code></pre>

<h3>Packaging caveat</h3>

<p>As mentioned in the begining of this article I couldn't use <strong>rake</strong> to <em>tar</em> this project up for deployment to RubyForge.
The reason is that <strong>rake</strong> makes a Unix platform dependent call to <em>tar</em> the package using a Ruby task file <strong>packagetask.rb</strong> located:</p>

<pre><code>C:\ruby\lib\ruby\gems\1.8\gems\rake-0.8.1\lib\rake 
</code></pre>

<p>This means that on Windows you will have to manually <em>tar</em> this file.</p>

<p>However you can still create the gem using the rake task, and a gem file <strong>my_app-0.0.1.gem</strong>, will appear in the <strong>pkg</strong> directory:</p>

<pre><code>rake gem
</code></pre>

<p>This new RubyGem can now be installed by using the <strong>gem install</strong> commands:</p>

<pre><code>gem install pkg/my_app-0.0.1.gem
</code></pre>

<p>You should get the following output:</p>

<pre><code>For more information on my_app, see http://my_app.rubyforge.org

NOTE: Change this information in PostInstall.txt
You can also delete it if you don't want it.


Successfully installed my_app, version 0.0.1
Installing ri documentation for my_app-0.0.1...
Installing RDoc documentation for my_app-0.0.1...
</code></pre>

<p>Finally you should now be able to execute your command-line command in the command prompt, simply by typing:</p>

<pre><code>greetings
</code></pre>

<p>I hope this is useful and helps with your understanding of how RubyGems work, specifically on Windows, also please jot down some comments if you have any ideas or suggestions.</p>

<h2>Links</h2>

<p>Here is a list of useful RubyGems links:</p>

<ul>
<li><a href="http://www.rubygems.org/">RubyGems.org</a></li>
<li><a href="http://www.linuxjournal.com/article/8967">Linux Journal article about RubyGems</a></li>
<li><a href="http://drnicwilliams.com/2006/10/11/generating-new-gems/">Dr Nic's generating new gems article</a></li>
<li><a href="http://drnicwilliams.com/2006/10/18/create-and-deploy-command-line-apps-with-rubygems/">Dr Nic's article for creating and deploying command line apps</a></li>
<li><a href="http://nubyonrails.com/articles/tutorial-publishing-rubygems-with-hoe">NubyOnRails article for using Hoe</a></li>
<li><a href="http://blog.jayfields.com/2006/10/ruby-project-tree.html">Jay Fields Ruby Project Tree</a></li>
</ul>


</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>24 Jun 2010</span> &raquo; <a href="/2010/06/ruby-quine-example">Ruby Quine Example</a></li>
    
      <li><span>11 May 2010</span> &raquo; <a href="/2010/05/what-is-the-difference-between-a-proc-and-a-lambda-in-ruby">What is the Difference Between a Proc and a Lambda in Ruby?</a></li>
    
      <li><span>09 May 2010</span> &raquo; <a href="/2010/05/code-kata-four-exercise-a-ruby-solution">Code Kata Four Exercise - A Ruby Solution</a></li>
    
  </ul>
</div>
 
            <div class="footer">  
					    <div class="rss">
					      <a href="http://feeds.feedburner.com/ben-emson">
					        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
					      </a>
					    </div>
                <p>A project by <a href="http://blog.emson.co.uk">Ben Emson</a> | <a href="http://twitter.com/emson">@emson</a>.</p> 
            </div> 
 
        </div> 
				<!-- Google Analytics -->
    </body> 
</html>